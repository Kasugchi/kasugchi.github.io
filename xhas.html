<!-- Chosen Palette: Corporate Calm -->
<!-- Application Structure Plan: The application is a multi-step form for incident reporting. A new "AI Analysis" step has been added, which uses the Gemini API to provide a summary, tone analysis, and recommendations based on the user's incident description. This enriches the data collection process before the user writes their conclusions. The printing functionality has been completely overhauled to use print-specific CSS, ensuring only the final report is printed, fixing a critical bug. -->
<!-- Visualization & Content Choices: The core is an interactive form. The new Gemini feature adds a data processing and visualization layer. -> Goal: Analyze user input with AI and present insights. -> Presentation Method: A dedicated step displays the AI-generated text in a structured format (summary, tone, recommendations). -> Interaction: A button triggers an asynchronous API call to Gemini, with a loading state to provide feedback. -> Justification: This provides significant value by offering an objective, AI-driven perspective on the incident, helping the user make better-informed decisions. -> Library/Method: Vanilla JS for the fetch API call to Gemini, Tailwind CSS for styling. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Incidencia RRHH con Gemini - Europea Group</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .invalid-field { border-color: #ef4444; box-shadow: 0 0 0 2px #fecaca; }
        .progress-step { transition: all 0.3s ease; }
        .progress-step.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .progress-step.completed { background-color: #16a34a; color: white; border-color: #16a34a; }
        .required-star { color: #ef4444; }

        /* Spinner for AI analysis button */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- FIX FOR PRINTING --- */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-only-area, #print-only-area * {
                visibility: visible;
            }
            #print-only-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8 transition-all duration-500 printable-container">
        <div id="form-container">
            <header class="text-center mb-8 no-print">
                <img src="https://i.imgur.com/gSH5c7L.png" alt="Logotipo Europea Group" class="mx-auto h-auto" style="max-height: 64px;">
                <h1 class="text-2xl font-bold text-gray-800 mt-4">INFORME INCIDENCIA RRHH</h1>
                <p class="text-md text-gray-500">EUROPEA GROUP</p>
            </header>

            <div id="progress-bar" class="flex items-center justify-center mb-10 space-x-2 no-print"></div>

            <main>
                <form id="incident-form" novalidate>
                    <!-- Step 1: Datos Generales -->
                    <section class="form-section active" data-step="0">
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">1. Datos Generales</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="incident-report-number" class="block text-sm font-medium text-gray-600 mb-1">Nº Informe Incidencia</label><input type="text" id="incident-report-number" name="incident-report-number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: RRHH-2024-001"></div>
                            <div><label for="associated-kpi" class="block text-sm font-medium text-gray-600 mb-1">KPI Asociado</label><input type="text" id="associated-kpi" name="associated-kpi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Reducción de absentismo"></div>
                            <div><label for="informant-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre del Informante <span class="required-star">*</span></label><input type="text" id="informant-name" name="informant-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Juan Pérez"></div>
                            <div><label for="informant-title" class="block text-sm font-medium text-gray-600 mb-1">Cargo del Informante <span class="required-star">*</span></label><input type="text" id="informant-title" name="informant-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Gerente de Ventas"></div>
                            <div><label for="incident-datetime" class="block text-sm font-medium text-gray-600 mb-1">Fecha y Hora <span class="required-star">*</span></label><input type="datetime-local" id="incident-datetime" name="incident-datetime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="incident-location" class="block text-sm font-medium text-gray-600 mb-1">Lugar del Incidente <span class="required-star">*</span></label><input type="text" id="incident-location" name="incident-location" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Oficina Central"></div>
                        </div>
                    </section>
                    <!-- Step 2: Involucrados -->
                    <section class="form-section" data-step="1">
                         <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">2. Personas Involucradas</h2>
                        <div class="bg-gray-50 p-6 rounded-lg">
                             <h3 class="font-semibold text-gray-600 mb-4">Empleado Principal</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="main-employee-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre <span class="required-star">*</span></label><input type="text" id="main-employee-name" name="main-employee-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                                <div><label for="main-employee-title" class="block text-sm font-medium text-gray-600 mb-1">Cargo <span class="required-star">*</span></label><input type="text" id="main-employee-title" name="main-employee-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
                            </div>
                        </div>
                        <div class="mt-6"><label for="other-involved" class="block text-sm font-medium text-gray-600 mb-1">Otras personas involucradas (nombres, cargos)</label><textarea id="other-involved" name="other-involved" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea></div>
                    </section>
                    <!-- Step 3: Descripción -->
                    <section class="form-section" data-step="2">
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">3. Descripción Detallada de la Incidencia</h2>
                        <p class="text-center text-sm text-gray-500 mb-4">Proporcione un relato objetivo y cronológico de los hechos. <span class="required-star">*</span></p>
                        <textarea id="incident-description" name="incident-description" required rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </section>
                    <!-- NEW Step 4: AI Analysis -->
                    <section class="form-section" data-step="3">
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">4. Análisis con IA (Gemini)</h2>
                        <p class="text-center text-sm text-gray-500 mb-4">Utiliza la IA para obtener un resumen objetivo y recomendaciones basadas en la descripción que has proporcionado.</p>
                        <div class="flex justify-center mb-6">
                            <button id="analyze-btn" type="button" class="flex items-center justify-center gap-2 px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9Z"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.5 12c0-1.5-1.5-3-1.5-3s-1.5 1.5-1.5 3 1.5 3 1.5 3-1.5-1.5-1.5-3"/><path d="M4.5 12c0-1.5 1.5-3 1.5-3s1.5 1.5 1.5 3-1.5 3-1.5 3 1.5-1.5 1.5-3"/></svg>
                                Analizar con Gemini
                            </button>
                        </div>
                        <div id="ai-results-container" class="bg-gray-50 p-6 rounded-lg space-y-4" style="display: none;"></div>
                    </section>
                    <!-- Step 5: Histórico -->
                    <section class="form-section" data-step="4">
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">5. Histórico de Incidencias</h2>
                        <p class="text-center text-sm text-gray-500 mb-4">Señale si alguna de las personas involucradas ha tenido incidentes previos.</p>
                        <textarea id="incident-history" name="incident-history" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Si no existen, escriba 'Ninguno'."></textarea>
                    </section>
                    <!-- Step 6: Acciones Inmediatas -->
                    <section class="form-section" data-step="5">
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">6. Acciones Inmediatas Tomadas</h2>
                        <p class="text-center text-sm text-gray-500 mb-4">Describa las medidas que se tomaron inmediatamente.</p>
                        <textarea id="immediate-actions" name="immediate-actions" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </section>
                    <!-- Step 7: Conclusiones -->
                    <section class="form-section" data-step="6">
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">7. Conclusiones y Medidas</h2>
                        <div class="space-y-6">
                            <div><label for="conclusions" class="block text-sm font-medium text-gray-600 mb-1">Conclusiones del Informe</label><textarea id="conclusions" name="conclusions" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Resumen de los hechos y valoración final."></textarea></div>
                            <div><label for="disciplinary-actions" class="block text-sm font-medium text-gray-600 mb-1">Medidas Disciplinarias Propuestas</label><textarea id="disciplinary-actions" name="disciplinary-actions" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Si no aplica, escriba 'Ninguna'."></textarea></div>
                        </div>
                    </section>
                    <!-- Step 8: Revisar -->
                    <section class="form-section printable-section" data-step="7">
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">8. Revisar y Enviar</h2>
                        <p class="text-center text-sm text-gray-500 mb-6 no-print">Verifique que toda la información sea correcta.</p>
                        <div id="summary" class="space-y-4 text-sm text-gray-800 bg-gray-50 p-6 rounded-lg"></div>
                    </section>
                </form>
            </main>

            <footer class="mt-8 flex justify-between items-center no-print">
                <button id="prev-btn" class="px-6 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition-colors" style="display: none;">Anterior</button>
                <div class="ml-auto flex items-center space-x-4">
                    <button id="share-btn" type="button" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors" style="display: none;">Guardar Enlace</button>
                    <button id="print-btn" type="button" class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition-colors" style="display: none;">Imprimir PDF</button>
                    <button id="next-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Siguiente</button>
                </div>
            </footer>
        </div>

        <div id="success-message" class="text-center py-12" style="display: none;">
            <div id="success-content">
                <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <h2 class="text-2xl font-bold text-gray-800 mt-4">Informe Enviado</h2>
                <p class="text-gray-600 mt-2">Su informe ha sido registrado correctamente.</p>
                <div class="mt-8 flex justify-center space-x-4 no-print">
                    <button id="print-final-btn" class="px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition-colors">Imprimir una copia</button>
                    <button onclick="window.location.href=window.location.href.split('?')[0]" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Crear nuevo informe</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 no-print" style="display: none; z-index: 50;">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Enlace para compartir y guardar</h3>
            <p class="text-sm text-gray-600 mb-2">Cualquier persona con este enlace podrá ver y editar los datos de este informe.</p>
            <textarea id="share-url" class="w-full p-2 border border-gray-300 rounded-md text-xs bg-gray-50" readonly rows="3"></textarea>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="copy-link-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Copiar Enlace</button>
                <button id="close-modal-btn" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Container for the final printable report. It's hidden by default and only shown for printing. -->
    <div id="print-only-area" class="hidden"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const steps = ['Datos', 'Involucrados', 'Descripción', 'Análisis IA', 'Histórico', 'Acciones', 'Conclusiones', 'Revisar'];
            const form = document.getElementById('incident-form');
            const formSections = document.querySelectorAll('.form-section');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const printBtn = document.getElementById('print-btn');
            const shareBtn = document.getElementById('share-btn');
            const progressBar = document.getElementById('progress-bar');
            const formContainer = document.getElementById('form-container');
            const successMessage = document.getElementById('success-message');
            const shareModal = document.getElementById('share-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const aiResultsContainer = document.getElementById('ai-results-container');
            const printOnlyArea = document.getElementById('print-only-area');
            const printFinalBtn = document.getElementById('print-final-btn');

            let currentStep = 0;

            const updateProgressBar = () => {
                progressBar.innerHTML = '';
                steps.forEach((step, index) => {
                    const stepEl = document.createElement('div');
                    stepEl.className = 'progress-step flex-shrink-0 flex flex-col items-center';
                    const circle = document.createElement('div');
                    let circleClasses = 'w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold ';
                    if (index < currentStep) {
                        circleClasses += 'completed';
                        circle.innerHTML = '&#10003;';
                    } else if (index === currentStep) {
                        circleClasses += 'active';
                        circle.textContent = index + 1;
                    } else {
                        circleClasses += 'bg-white border-gray-300 text-gray-400';
                        circle.textContent = index + 1;
                    }
                    circle.className = circleClasses;
                    const label = document.createElement('p');
                    let labelClasses = 'text-xs mt-2 text-center ';
                    labelClasses += (index === currentStep) ? 'text-blue-600 font-semibold' : 'text-gray-500';
                    label.className = labelClasses;
                    label.textContent = step;
                    stepEl.appendChild(circle);
                    stepEl.appendChild(label);
                    progressBar.appendChild(stepEl);
                });
            };

            const showStep = (stepIndex) => {
                formSections.forEach((section, index) => section.classList.toggle('active', index === stepIndex));
                updateProgressBar();
                updateButtons();
            };

            const updateButtons = () => {
                prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-block';
                const onFinalStep = currentStep === steps.length - 1;
                printBtn.style.display = onFinalStep ? 'inline-block' : 'none';
                shareBtn.style.display = onFinalStep ? 'inline-block' : 'none';
                nextBtn.textContent = onFinalStep ? 'Enviar Informe' : 'Siguiente';
            };
            
            const validateStep = (stepIndex) => {
                let isValid = true;
                const inputs = formSections[stepIndex].querySelectorAll('input[required], textarea[required]');
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        isValid = false;
                        input.classList.add('invalid-field');
                    } else {
                        input.classList.remove('invalid-field');
                    }
                });
                return isValid;
            };
            
            form.addEventListener('input', (e) => {
                if (e.target.hasAttribute('required')) {
                    if (e.target.value.trim()) e.target.classList.remove('invalid-field');
                }
            });

            const getFormData = () => Object.fromEntries(new FormData(form).entries());

            const generateSummaryHTML = () => {
                const data = getFormData();
                const summaryMap = {
                    'Nº Informe Incidencia': data['incident-report-number'], 'KPI Asociado': data['associated-kpi'],
                    'Nombre del Informante': data['informant-name'], 'Cargo del Informante': data['informant-title'],
                    'Fecha y Hora': data['incident-datetime'], 'Lugar del Incidente': data['incident-location'],
                    'Empleado Principal': `${data['main-employee-name'] || 'N/A'} (${data['main-employee-title'] || 'N/A'})`,
                    'Otras Personas Involucradas': data['other-involved'], 'Descripción': data['incident-description'],
                    'Histórico de Incidencias': data['incident-history'], 'Acciones Inmediatas': data['immediate-actions'],
                    'Conclusiones': data['conclusions'], 'Medidas Disciplinarias': data['disciplinary-actions'],
                };
                let summaryHTML = '';
                for(const [key, value] of Object.entries(summaryMap)) {
                    const displayValue = (value || 'No completado').replace(/\n/g, '<br>');
                    summaryHTML += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b py-3 last:border-b-0"><strong class="font-semibold text-gray-600 col-span-1">${key}</strong><p class="text-gray-800 col-span-2 break-words">${displayValue}</p></div>`;
                }
                document.getElementById('summary').innerHTML = summaryHTML;
                return summaryHTML;
            };

            const handleAnalyzeClick = async () => {
                const description = document.getElementById('incident-description').value;
                if (!description.trim()) {
                    aiResultsContainer.innerHTML = `<p class="text-red-600">Por favor, escribe primero la descripción del incidente.</p>`;
                    aiResultsContainer.style.display = 'block';
                    return;
                }

                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = `<div class="spinner"></div><span>Analizando...</span>`;
                aiResultsContainer.style.display = 'block';
                aiResultsContainer.innerHTML = `<p class="text-gray-600">Contactando a Gemini, por favor espera...</p>`;

                try {
                    const systemPrompt = `Eres un asistente experto de RRHH. Analiza el siguiente informe de incidencia. Proporciona una respuesta estructurada con tres secciones claras: 1. Un resumen objetivo y conciso de los hechos. 2. Un análisis del tono del texto (neutral, emocional, acusatorio, etc.). 3. Una lista de 3 a 5 recomendaciones o siguientes pasos sugeridos. Formatea tu respuesta con los títulos: "Resumen:", "Análisis de Tono:" y "Recomendaciones:".`;
                    const userQuery = `Analiza la siguiente descripción de una incidencia: "${description}"`;
                    
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        const htmlResult = text
                            .replace(/Resumen:/g, '<h3 class="font-semibold text-gray-800">Resumen</h3>')
                            .replace(/Análisis de Tono:/g, '<h3 class="font-semibold text-gray-800 mt-4">Análisis de Tono</h3>')
                            .replace(/Recomendaciones:/g, '<h3 class="font-semibold text-gray-800 mt-4">Recomendaciones</h3>')
                            .replace(/\* /g, '<li class="ml-5 list-disc">')
                            .replace(/\n/g, '<br>');
                        aiResultsContainer.innerHTML = htmlResult;
                    } else {
                        throw new Error("No se recibió contenido válido de la IA.");
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    aiResultsContainer.innerHTML = `<p class="text-red-600">Hubo un error al contactar con la IA. Por favor, inténtalo de nuevo más tarde.</p>`;
                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9Z"/><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.5 12c0-1.5-1.5-3-1.5-3s-1.5 1.5-1.5 3 1.5 3 1.5 3-1.5-1.5-1.5-3"/><path d="M4.5 12c0-1.5 1.5-3 1.5-3s1.5 1.5 1.5 3-1.5 3-1.5 3 1.5-1.5 1.5-3"/></svg>Analizar con Gemini`;
                }
            };

            const populateFormFromUrl = () => {
                const params = new URLSearchParams(window.location.search);
                if (params.has('data')) {
                    try {
                        const encodedData = params.get('data');
                        const decodedJson = decodeURIComponent(escape(atob(encodedData)));
                        const formData = JSON.parse(decodedJson);
                        for (const key in formData) {
                           if(form.elements[key]) form.elements[key].value = formData[key];
                        }
                        currentStep = steps.length - 1; 
                        generateSummaryHTML();
                    } catch(e) { console.error("Error parsing data from URL:", e); }
                }
            };
            
            nextBtn.addEventListener('click', () => {
                if (!validateStep(currentStep)) return;
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    if (currentStep === steps.length - 1) generateSummaryHTML();
                    showStep(currentStep);
                } else {
                    const finalSummaryHTML = generateSummaryHTML();
                    const logoSrc = document.querySelector('header img').src;
                    printOnlyArea.innerHTML = `
                        <header class="text-center mb-8"><img src="${logoSrc}" alt="Logotipo" class="mx-auto h-auto" style="max-height: 64px;"><h1 class="text-2xl font-bold text-gray-800 mt-4">INFORME INCIDENCIA RRHH</h1><p class="text-md text-gray-500">EUROPEA GROUP</p></header>
                        <h2 class="text-xl font-semibold mb-6 text-center text-gray-700">Resumen del Informe</h2>
                        <div class="space-y-4 text-sm text-gray-800 bg-gray-50 p-6 rounded-lg">${finalSummaryHTML}</div>`;
                    formContainer.style.display = 'none';
                    successMessage.style.display = 'block';
                }
            });

            prevBtn.addEventListener('click', () => { if (currentStep > 0) { currentStep--; showStep(currentStep); } });
            printBtn.addEventListener('click', () => { generateSummaryHTML(); window.print(); });
            printFinalBtn.addEventListener('click', () => window.print());
            analyzeBtn.addEventListener('click', handleAnalyzeClick);
            closeModalBtn.addEventListener('click', () => shareModal.style.display = 'none');
            
            shareBtn.addEventListener('click', () => {
                const data = getFormData();
                const jsonString = JSON.stringify(data);
                const encodedData = btoa(unescape(encodeURIComponent(jsonString)));
                document.getElementById('share-url').value = `${window.location.href.split('?')[0]}?data=${encodedData}`;
                shareModal.style.display = 'flex';
            });
            copyLinkBtn.addEventListener('click', () => {
                const shareUrlInput = document.getElementById('share-url');
                shareUrlInput.select();
                document.execCommand('copy');
                copyLinkBtn.textContent = '¡Copiado!';
                setTimeout(() => { copyLinkBtn.textContent = 'Copiar Enlace'; }, 2000);
            });

            populateFormFromUrl();
            showStep(currentStep);
        });
    </script>
</body>
</html>


